name: 每日中美热点新闻推送微信

on:
  schedule:
    - cron: '0 0 * * *'  # 北京时间 8:00
  workflow_dispatch:

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install feedparser requests

      - name: Run news script
        env:
          SCKEY: ${{ secrets.SCKEY }}
        run: |
          python << 'EOF'
import feedparser
import requests
from datetime import datetime

# 获取密钥
sckey = '${{ secrets.SCKEY }}'.strip()
if not sckey or sckey == 'None':
    print("SCKEY 未设置！请到 Settings > Secrets 添加")
    exit(1)

# 中国热点
try:
    cn = feedparser.parse('https://rsshub.app/weibo/search/hot')['entries'][:3]
    cn_lines = []
    for e in cn:
        title = e.title.split('[')[0].strip()[:50]
        cn_lines.append(f"• {title}...\n  {e.link}")
    cn_text = "China 中国热点：\n" + "\n".join(cn_lines)
except:
    cn_text = "China 中国热点：暂无数据"

# 美国热点
try:
    us = feedparser.parse('https://news.google.com/rss?hl=en-US&gl=US&ceid=US:en')['entries'][:3]
    us_lines = []
    for e in us:
        title = e.title.split(' - ')[0][:50]
        us_lines.append(f"• {title}...\n  {e.link}")
    us_text = "USA 美国热点：\n" + "\n".join(us_lines)
except:
    us_text = "USA 美国热点：暂无数据"

# 组装消息（避免 f-string 嵌套）
today = datetime.now().strftime('%Y-%m-%d')
time_now = datetime.now().strftime('%H:%M')
title = f"每日热点速递 {today}"
desp = f"{cn_text}\n\n{us_text}\n\n---\n更新于 {time_now} | GitHub Actions"

# 发送
url = f"https://sctapi.ftqq.com/{sckey}.send"
data = {'title': title, 'desp': desp}
resp = requests.post(url, data=data)
print(f"推送状态: {resp.status_code}")
if resp.status_code == 200:
    print("微信推送成功！")
else:
    print(f"推送失败: {resp.text}")
EOF
